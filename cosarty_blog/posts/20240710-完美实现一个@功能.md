---
description: å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½
tag:
  - javascript
category:
  - å‰ç«¯
date: 2024-07-10
---

# å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½



## text/textarea æ–‡æœ¬è¾“å…¥æ¡†ä¸­æ“ä½œå…‰æ ‡é€‰åŒº

é¦–å…ˆçœ‹è¿™ç±»æ“ä½œæ–¹å¼ï¼Œå‡ ä¹å¯ä»¥ä¸ç”¨ `Selection`å’Œ `Range`ç›¸å…³ APIï¼Œä½¿ç”¨çš„æ˜¯æ–‡æœ¬è¾“å…¥æ¡†å…ƒç´ åŸç”Ÿæ–¹æ³•ã€‚

### ä¸»åŠ¨é€‰ä¸­æŸä¸€åŒºåŸŸ

ä¸»åŠ¨é€‰ä¸­åœ¨æ–‡æœ¬è¾“å…¥æ¡†å…ƒç´ æŸä¸€åŒºåŸŸå¯ä»¥ä½¿ç”¨ [setSelectionRange](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FHTMLInputElement%2FsetSelectionRange) ã€‚

> element.setSelectionRange(selectionStart, selectionEnd [, selectionDirection]);

- selectionStart è¢«é€‰ä¸­çš„ç¬¬ä¸€ä¸ªå­—ç¬¦çš„ä½ç½®ç´¢å¼•ï¼Œä» 0 å¼€å§‹ã€‚
- selectionEnd è¢«é€‰ä¸­çš„æœ€åä¸€ä¸ªå­—ç¬¦çš„ ä¸‹ä¸€ä¸ª ä½ç½®ç´¢å¼•ã€‚
- selectionDirection é€‰æ‹©æ–¹å‘çš„å­—ç¬¦ä¸²ã€‚

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç $input.setSelectionRange(0, 6);
// $input.select() // å…¨éƒ¨é€‰ä¸­
$input.focus();
```

![setSelectionRange.gif](20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/0552977a52c844d7be638911705555dc~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png)

### èšç„¦åˆ°æŸä¸€ä½ç½®

å¦‚æœæˆ‘ä»¬æƒ³æŠŠå…‰æ ‡ç§»åŠ¨åˆ° ğŸ˜ƒğŸ˜„ğŸ˜ åé¢ï¼Œå…¶å®æ˜¯å°†é€‰åŒºèµ·å§‹ä½ç½®è®¾ç½®ç›¸åŒçš„æ•ˆæœ

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç $input.setSelectionRange(6, 6);
$input.focus();
```

![setSelectionRange1.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/f8311e0c82da43b98330244f2eb07f8d~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png)

### è¿˜åŸä¹‹å‰çš„é€‰åŒº

æœ‰äº›åœºæ™¯ï¼Œæˆ‘ä»¬é€‰æ‹©äº†å½“å‰`input`æ–‡æœ¬æ¡†é€‰åŒºï¼Œè¦å»åšåˆ«çš„æ“ä½œï¼Œå›æ¥åè¦æ¢å¤é€‰åŒºï¼Œè¿™æ—¶åœ¨åšåˆ«çš„æ“ä½œä¹‹å‰å°±è¦å°†é€‰åŒºä½ç½®å­˜ä¸‹æ¥ï¼Œä¼šç”¨åˆ°`selectionStart`å’Œ `selectionEnd`ä¸¤ä¸ªå±æ€§ã€‚

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç $input.addEventListener('mouseup', () => {
  this.pos = {
    start: $input.selectionStart,
    end: $input.selectionEnd,
  };
});

const { start, end } = this.pos;
$input.setSelectionRange(start, end);
$input.focus();
```

![setSelectionRange2.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/da9ad454f69f4217b570f0d34ff8473f~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png)

### åœ¨æŒ‡å®šé€‰åŒºæ’å…¥ï¼ˆæ›¿æ¢ï¼‰å†…å®¹

æŒ‡å®šæ–‡æœ¬è¾“å…¥æ¡†çš„æŸä¸ªä½ç½®æ’å…¥å†…å®¹æˆ–è€…æ›¿æ¢é€‰åŒºçš„å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨ [setRangeText](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FHTMLInputElement%2FsetRangeText) å®ç°ã€‚

> setRangeText(replacement) setRangeText(replacement, start, end, selectMode)

è¿™ä¸ªæ–¹æ³•æœ‰ 2 ç§å½¢å¼ï¼Œç¬¬äºŒç§å½¢å¼æœ‰ 4 ä¸ªå‚æ•°ï¼š

- ç¬¬ä¸€ä¸ªå‚æ•°`replacement`æ˜¯æ›¿æ¢æ–‡æœ¬ï¼›
- `start`å’Œ `end`æ˜¯èµ·å§‹ä½ç½®ï¼Œé»˜è®¤å€¼è¯¥å…ƒç´ å½“å‰é€‰ä¸­çš„åŒºåŸŸçš„ä½ç½®ï¼›
- æœ€åä¸€ä¸ªå‚æ•°`selectMode`æ˜¯æ›¿æ¢åé€‰åŒºçš„çŠ¶æ€ï¼Œå®ƒæœ‰ 4 ä¸ªçŠ¶æ€ï¼šselectï¼ˆæ›¿æ¢åé€‰ä¸­ï¼‰ã€startï¼ˆæ›¿æ¢åå…‰æ ‡ä½äºæ›¿æ¢è¯ä¹‹å‰ï¼‰ã€endï¼ˆæ›¿æ¢åå…‰æ ‡ä½äºæ›¿æ¢è¯ä¹‹åï¼‰å’Œ preserveï¼ˆé»˜è®¤å€¼ï¼Œå°è¯•ä¿ç•™é€‰åŒºï¼‰ï¼›

æˆ‘ä»¬å°†å…‰æ ‡æˆ–è€…é€‰åŒºä½ç½®æ’å…¥æˆ–è€…æ›¿æ¢æ–‡æœ¬ ğŸ˜‚ğŸ˜‚ğŸ˜‚ï¼Œå¯ä»¥è¿™æ ·

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç $input.setRangeText('ğŸ˜‚ğŸ˜‚ğŸ˜‚');
$input.focus();
```

![setRangeText.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/264b5e076017421c86ea5bcac912adff~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) ä¸‹é¢å†æ¥çœ‹çœ‹ç¬¬äºŒç§æœ‰ 4 ä¸ªå‚æ•°å½¢å¼ï¼Œå‘ç°ä¼šåœ¨æˆ‘ä»¬æŒ‡å®šçš„èµ·å§‹ä½ç½®æ’å…¥å†…å®¹åï¼Œå½“å‰çš„é€‰åŒºå’Œå…‰æ ‡å°è¯•ä¿ç•™ã€‚æ›¿æ¢åé€‰åŒºçš„çŠ¶æ€å¦å¤– 3 ç§åœºæ™¯å¤§å®¶å¯ä»¥è‡ªè¡Œæµ‹è¯•ã€‚

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç $input.setRangeText('ğŸ˜‚ğŸ˜‚ğŸ˜‚', 8, 8, 'preserve');
$input.focus();
```

![setRangeText1.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/65dc2cdd591a4a34bddfa26d0906116c~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) å…³äºé€‰åŒºçš„æ“ä½œåœ¨ input/textarea è¾“å…¥æ¡†ä¸­çš„æ“ä½œå¸¸ç”¨çš„å·®ä¸å¤šå°±è¿™äº›ï¼Œä¸‹é¢ç®€å•æ€»ç»“ä¸€ä¸‹ ![img](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/04a14d6b906540369c842cf4c4300164~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png)

## å¯Œæ–‡æœ¬ä¸­æ“ä½œå…‰æ ‡é€‰åŒºâ€”â€”Selection & Range

### è®¾ç½®å¯Œæ–‡æœ¬

é¦–å…ˆå¯Œæ–‡æœ¬å…ƒç´ æ˜¯å¯ç¼–è¾‘å…ƒç´ ï¼Œå¯ä»¥åœ¨å…ƒç´ ä¸Šçœ‹åˆ°å…‰æ ‡ï¼Œé™¤äº†è¡¨å•å…ƒç´ ï¼Œè¿˜æœ‰ç»™æ™®é€šå…ƒç´ æ·»åŠ å±æ€§å¯ä»¥è½¬æ¢æ–‡å¯Œæ–‡æœ¬å…ƒç´ ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸‹ä¸‰ç§æ–¹å¼è½¬æ¢ã€‚

- ç»™å…ƒç´ æ·»åŠ å±æ€§ `contenteditable="true"`ï¼›
- æ·»åŠ  CSS å±æ€§ `-webkit-user-modify: "read-write"`ï¼›
- é€šè¿‡ js çš„ `document.designMode="on"`æ–¹å¼è®¾ç½®ï¼›

### Selection & Range

åœ¨å¯Œæ–‡æœ¬ä¸­å¯¹å…‰æ ‡åŠé€‰åŒºçš„æ“ä½œï¼Œä¸å¾—ä¸æ JavaScript çš„ä¸¤ä¸ªåŸç”Ÿå¯¹è±¡ï¼š [Selection](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FSelection) å’Œ [Range](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FRange%2FRange) ã€‚

- **Selection** å¯¹è±¡è¡¨ç¤ºç”¨æˆ·é€‰æ‹©çš„æ–‡æœ¬èŒƒå›´æˆ–æ’å…¥ç¬¦å·çš„å½“å‰ä½ç½®ã€‚å®ƒä»£è¡¨é¡µé¢ä¸­çš„æ–‡æœ¬é€‰åŒºï¼Œå¯èƒ½æ¨ªè·¨å¤šä¸ªå…ƒç´ ã€‚æ–‡æœ¬é€‰åŒºç”±ç”¨æˆ·æ‹–æ‹½é¼ æ ‡ç»è¿‡æ–‡å­—è€Œäº§ç”Ÿã€‚è¦è·å–ç”¨äºæ£€æŸ¥æˆ–ä¿®æ”¹çš„ `Selection` å¯¹è±¡ï¼Œè¯·è°ƒç”¨ [window.getSelection()](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWindow%2FgetSelection)ã€‚
- **Range** å¯¹è±¡è¡¨ç¤ºåŒ…å«èŠ‚ç‚¹å’Œéƒ¨åˆ†æ–‡æœ¬èŠ‚ç‚¹çš„æ–‡æ¡£ç‰‡æ®µã€‚é€šè¿‡ `selection`å¯¹è±¡è·å¾—çš„ `range`å¯¹è±¡æ‰æ˜¯æˆ‘ä»¬æ“ä½œå…‰æ ‡çš„é‡ç‚¹ã€‚

![image.png](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/2b137c6625454fd0ac3587996812a79b~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) å¤§å®¶å¯èƒ½æ³¨æ„åˆ° `getRangeAt(0)`ï¼Œé€‰åŒºå¯èƒ½ä¼šæœ‰å¤šä¸ª `range`? è¿˜çœŸæ˜¯ï¼Œåœ¨ Firefox æ”¯æŒå¤šä¸ªé€‰åŒºï¼Œé€šè¿‡ `cmd`é”®ï¼ˆ`windows`ä¸Šæ˜¯ `ctrl`é”®ï¼‰å¯ä»¥å®ç°å¤šé€‰åŒºã€‚ ![image.png](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/5c79a0670c8a454c82cb62c32b13aaf2~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) å†çœ‹ä¸€ä¸ª range è¿”å›çš„ä¸€ä¸ªå±æ€§ï¼Œ`collapsed`ï¼Œè¡¨ç¤ºé€‰åŒºçš„èµ·ç‚¹ä¸ç»ˆç‚¹æ˜¯å¦é‡å ã€‚å½“`collapsed`ä¸º`true`æ—¶ï¼Œé€‰ä¸­åŒºåŸŸè¢«å‹ç¼©æˆä¸€ä¸ªç‚¹ï¼Œå¯¹äºæ™®é€šçš„å…ƒç´ ï¼Œå¯èƒ½ä»€ä¹ˆéƒ½çœ‹ä¸åˆ°ï¼Œå¦‚æœæ˜¯åœ¨å¯ç¼–è¾‘å…ƒç´ ä¸Šï¼Œé‚£è¿™ä¸ªè¢«å‹ç¼©çš„ç‚¹å°±å˜æˆäº†å¯ä»¥é—ªçƒçš„å…‰æ ‡ã€‚

### ä¸»åŠ¨é€‰ä¸­å¯Œæ–‡æœ¬çš„æŸä¸ªèŠ‚ç‚¹

é€‰ä¸­å¯Œæ–‡æœ¬ä¸­çš„æŸä¸ªç‹¬ç«‹æ ‡ç­¾ï¼Œå¯ä»¥ç”¨åˆ°ä¸¤ä¸ª APIï¼Œ[Range.selectNode()](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FRange%2FselectNode) å’Œ [Range.selectNodeContent()](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FRange%2FselectNodeContents)ï¼Œä¸¤è€…ä¸åŒçš„æ˜¯å‰è€…åŒ…æ‹¬èŠ‚ç‚¹è‡ªèº«ï¼Œåè€…ä¸åŒ…æ‹¬è‡ªèº«ã€‚æ¯”å¦‚æˆ‘ä»¬æƒ³ç‹¬ç«‹é€‰ä¸­å¯Œæ–‡æœ¬çš„ç¬¬äºŒä¸ªå­å…ƒç´ `<span style="color: #00965e;">Selection</span>` ï¼Œä½¿ç”¨ `Range.selectNode()` API é€‰ä¸­å…ƒç´ ï¼Œåˆ é™¤çš„æ˜¯æ•´ä¸ªå…ƒç´ ï¼Œå†è¾“å…¥å†…å®¹æ˜¯æ²¡æœ‰æ ·å¼çš„ã€‚

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç const $span = $input.childNodes[1];
range.selectNode($span);
selection.removeAllRanges();
selection.addRange(range);
```

![selectNode1.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/4fc4bd9716744b5a882ac162b25e1d4f~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) å½“ç„¶éƒ¨åˆ†æµè§ˆå™¨ï¼ˆæ¯”å¦‚ Chrome104ï¼‰æ˜¯æœ‰å·®å¼‚çš„ï¼Œåœ¨åˆ é™¤æ•´ä¸ªèŠ‚ç‚¹åï¼Œæ–°è¾“å…¥çš„å†…å®¹æ—¶ä¼šæ’å…¥ä¸€ä¸ªæ ‡ç­¾ï¼ˆ`font`ï¼‰å¹¶é›†æˆä¹‹å‰çš„æ ·å¼ã€‚ ![selectNode.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/b3079bea0e454d9ba960145b39862b78~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) ä½¿ç”¨ `Range.selectNodeContents()` API é€‰ä¸­çš„æ˜¯èŠ‚ç‚¹å†…éƒ¨å†…å®¹ï¼Œå½“åˆ é™¤é€‰ä¸­å†…å®¹åï¼ŒèŠ‚ç‚¹æœ¬èº«è¿˜åœ¨ã€‚

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç const $span = $input.childNodes[1];
range.selectNodeContents($span);
selection.removeAllRanges();
selection.addRange(range);
```

![selectNode2.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/e4f303d278a14ae3a788841cb97b3a3c~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) ä»¥ä¸Šæ˜¯å¯¹å¯Œæ–‡æœ¬ä¸­å•ä¸ªèŠ‚ç‚¹çš„é€‰ä¸­æ“ä½œï¼Œç„¶è€Œï¼Œå®é™…ä¸Šå¯Œæ–‡æœ¬ä¸­çš„èŠ‚ç‚¹å¯èƒ½æ˜¯åµŒå¥—æˆ–è€…å¹³è¡Œçš„ï¼Œæ€æ ·è·¨å¤šä¸ªå…ƒç´ å»é€‰ä¸­æ“ä½œå‘¢ï¼Ÿ

### ä¸»åŠ¨é€‰ä¸­å¯Œæ–‡æœ¬çš„æŸä¸€åŒºåŸŸ

è¡¨å•è¾“å…¥æ¡†åªæœ‰å•ä¸€æ–‡æœ¬ï¼Œè€Œå¯Œæ–‡æœ¬å…ƒç´ æˆ–è€…æ™®é€šå…ƒç´ åŒ…å«å¤šä¸ªå…ƒç´ ã€‚å½“ä¸»åŠ¨é€‰ä¸­é¡µé¢æŸä¸€åŒºåŸŸï¼Œå…ˆè¦åˆ›å»ºä¸€ä¸ª`Range`å¯¹è±¡ï¼Œå¯èƒ½ä¼šè·¨å¤šä¸ªå…ƒç´ ï¼Œæ‰€ä»¥è¦è®¾ç½®é€‰åŒºçš„èµ·å§‹èŠ‚ç‚¹ï¼Œåˆ†åˆ«æ˜¯ [Range.setStart()](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FRange%2FsetStart) å’Œ [Range.setEnd()](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FRange%2FsetEnd) æ–¹æ³•ã€‚

> range.setStart(startNode, startOffset); range.setEnd(endNode, endOffset);

- startNode å¼€å§‹èŠ‚ç‚¹
- startOffset ä» startNode çš„å¼€å§‹ä½ç½®ç®—èµ·çš„åç§»é‡
- endNode ç»“æŸèŠ‚ç‚¹
- endOffset ä» endNode çš„ç»“æŸä½ç½®ç®—èµ·çš„åç§»é‡

ä¸Šé¢æ˜¯è®¾ç½®é€‰åŒºèŒƒå›´ï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°é€‰åŒºå¹¶é€‰ä¸­ [Selection.addRange()](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FSelection%2FaddRange)ã€‚ä¸è¿‡ï¼Œä¸€èˆ¬åœ¨æ·»åŠ å‰ï¼Œä¼šæ¸…é™¤ä¹‹å‰çš„é€‰åŒºï¼Œè¿™æ—¶å°±è¦ç”¨åˆ° [Selection.removeAllRanges()](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FSelection%2FremoveAllRanges) ã€‚

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç const selection = document.getSelection();
const range = document.createRange();
range.setStart($input.firstChild, 0);
range.setEnd($input.firstChild, 4);
selection.removeAllRanges();
selection.addRange(range);
```

![addRange.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/04cad9d7a9654d5288427c91a32a9cb3~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) æ³¨æ„è¿™é‡Œå–å¯Œæ–‡æœ¬å…ƒç´ çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ï¼ˆæ–‡æœ¬èŠ‚ç‚¹ï¼‰ï¼Œè€Œä¸æ˜¯å…ƒç´ æœ¬èº«ï¼Œå¦åˆ™å°±ä¼šè¶…å‡ºåç§»é‡ï¼Œå‡ºç°æŠ¥é”™ã€‚å› ä¸ºåœ¨è®¡ç®—å…ƒç´ èŠ‚ç‚¹å’Œæ–‡æœ¬èŠ‚ç‚¹åç§»é‡æ˜¯æœ‰å·®åˆ«çš„ï¼š

> å¦‚æœèµ·å§‹èŠ‚ç‚¹ç±»å‹æ˜¯ Textã€Comment æˆ– CDATASection ä¹‹ä¸€ï¼Œé‚£ä¹ˆ startOffset æŒ‡çš„æ˜¯ä»èµ·å§‹èŠ‚ç‚¹ç®—èµ·å­—ç¬¦çš„åç§»é‡ã€‚ å¯¹äºå…¶ä»– Node ç±»å‹èŠ‚ç‚¹ï¼ŒstartOffset æ˜¯æŒ‡ä»èµ·å§‹ç»“ç‚¹å¼€å§‹ç®—èµ·å­èŠ‚ç‚¹çš„åç§»é‡ã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚æœæˆ‘æƒ³é€‰ä¸­å¯Œæ–‡æœ¬å¼€å¤´è¿™ä¸€æ®µ `ğŸ˜ƒğŸ˜„ğŸ˜<span style="color: #00965e;">Selection</span> å¯¹è±¡`ï¼Œæ€æ ·å®ç°å‘¢ï¼Ÿ å¯¹äºæ¯”è¾ƒå¤æ‚çš„å¯Œæ–‡æœ¬å…ƒç´ ç»“æ„ï¼Œè¦å®ç°ä»»æ„åŒºé—´é€‰ä¸­ï¼Œå…³é”®è¦æ‰¾åˆ°èµ·å§‹èŠ‚ç‚¹å’Œç»“æŸèŠ‚ç‚¹ï¼Œä»¥åŠå®ƒä»¬å„è‡ªçš„åç§»é‡ã€‚ ![img](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/35c3ee7e728e4b53bd2ff81c95a15d2f~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png)

å¥½åƒæ²¡æœ‰æ›´å¥½çš„åŸç”Ÿæ–¹æ³•å¯ä»¥å€ŸåŠ©ï¼Œè¿™é‡Œæœ‰ä¸€ç§æ–¹æ¡ˆï¼Œé¦–å…ˆéå†å‡ºå¯Œæ–‡æœ¬åŒ…å«æ‰€æœ‰çš„æ–‡æœ¬èŠ‚ç‚¹ï¼Œç„¶åè®°å½•æ¯ä¸ªèŠ‚ç‚¹è¾¹ç•Œçš„åç§»é‡ï¼ŒæŸ¥æ‰¾å‡ºæ»¡è¶³åŒºé—´æ¡ä»¶çš„èµ·å§‹å’Œç»“æŸèŠ‚ç‚¹ï¼Œæœ€åä»èµ·å§‹å’Œç»“æŸèŠ‚ç‚¹ä¸­è®¡ç®—å„è‡ªéœ€è¦çš„æ–‡æœ¬åç§»é‡ã€‚

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç /**
 * è·å–æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹åŠå…¶åç§»é‡
 * @param {HTMLElement} wrapDom æœ€å¤–å±‚èŠ‚ç‚¹
 * @param {Number} start å¼€å§‹ä½ç½®
 * @param {Number} end ç»“æŸä½ç½®
 * @returns
 */
function getNodeAndOffset(wrapDom, start = 0, end = 0) {
  const txtList = [];
  const map = function (children) {
    [...children].forEach((el) => {
      if (el.nodeName === '#text') {
        txtList.push(el);
      } else {
        map(el.childNodes);
      }
    });
  };
  // é€’å½’éå†ï¼Œæå–å‡ºæ‰€æœ‰ #text
  map(wrapDom.childNodes);
  // è®¡ç®—æ–‡æœ¬çš„ä½ç½®åŒºé—´
  const clips = txtList.reduce((arr, item, index) => {
    const end =
      item.textContent.length + (arr[index - 1] ? arr[index - 1][2] : 0);
    arr.push([item, end - item.textContent.length, end]);
    return arr;
  }, []);
  // æŸ¥æ‰¾æ»¡è¶³æ¡ä»¶çš„èŒƒå›´åŒºé—´
  const startNode = clips.find((el) => start >= el[1] && start < el[2]);
  const endNode = clips.find((el) => end >= el[1] && end < el[2]);
  return [startNode[0], start - startNode[1], endNode[0], end - endNode[1]];
}
```

æœ‰äº†è¿™ä¸ªæˆ‘ä»¬è‡ªå·±å°è£…çš„å·¥å…·æ–¹æ³•ï¼Œå°±å¯ä»¥é€‰ä¸­ä»»æ„æ–‡å­—åŒºé—´ï¼Œè€Œä¸ç”¨è€ƒè™‘å¯Œæ–‡æœ¬çš„å…ƒç´ ç»“æ„ã€‚

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç const selection = document.getSelection();
const range = document.createRange();
const nodes = this.getNodeAndOffset($input, 4, 17);
range.setStart(nodes[0], nodes[1]);
range.setEnd(nodes[2], nodes[3]);
selection.removeAllRanges();
selection.addRange(range);
```

![getNodeAndOffset.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/7353d09921f2402084d5915624fb0a69~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png)

### èšç„¦åˆ°æŸä¸€ä½ç½®

é€šè¿‡ä¸Šé¢å·²å®ç°é€‰ä¸­ä»»æ„åŒºé—´æ–‡å­—ï¼Œå†æ¥çœ‹å°†å…‰æ ‡èšç„¦åˆ°æŸä¸€ä½ç½®ï¼Œå°±ç®€å•å¤šäº†ï¼Œåªé€‰å°†èµ·å§‹å’Œç»“æŸèŒƒå›´ä½ç½®è®¾ç½®ç›¸åŒå³å¯ã€‚

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç const selection = document.getSelection();
const range = document.createRange();
const nodes = this.getNodeAndOffset($input, 7, 7);
range.setStart(nodes[0], nodes[1]);
range.setEnd(nodes[2], nodes[3]);
selection.removeAllRanges();
selection.addRange(range);
```

![getNodeAndOffset1.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/94891dac3c9e45378b68f1dc752c9b2c~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png)

### è¿˜åŸä¹‹å‰çš„é€‰åŒº

åŒæ–‡æœ¬è¾“å…¥æ¡†ä¿å­˜å½“å‰çš„å…‰æ ‡ä½ç½®ï¼Œåœ¨å¯Œæ–‡æœ¬é‡Œï¼Œå¯ä»¥å°†æ•´ä¸ªé€‰åŒºéƒ½ä¿å­˜ä¸‹æ¥ï¼Œç„¶ååœ¨åé¢å¤åŸé€‰åŒºã€‚

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç // ä¿å­˜å…‰æ ‡
$input.addEventListener('mouseup', () => {
  const selection = document.getSelection();
  const range = selection.getRangeAt(0);
  this.lastRange = range;
});
// è¿˜åŸå…‰æ ‡
const selection = document.getSelection();
const range = document.createRange();
selection.removeAllRanges();
selection.addRange(this.lastRange);
```

![addRange1.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/ced0ff4152cc441ab72ea6663a11b4b6~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png)

### åœ¨æŒ‡å®šé€‰åŒºæ’å…¥ï¼ˆæ›¿æ¢ï¼‰å†…å®¹

åœ¨é€‰åŒºæ’å…¥å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨ [Range.insertNode()](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FRange%2FinsertNode) æ–¹æ³•ï¼Œå®ƒè¡¨ç¤ºåœ¨é€‰åŒºçš„èµ·ç‚¹å¤„æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”ä¸ä¼šæ›¿æ¢å½“å‰å·²ç»é€‰ä¸­çš„ï¼Œå¦‚æœéœ€è¦æ›¿æ¢ï¼Œå¯ä»¥å…ˆåˆ é™¤ï¼Œåˆ é™¤é€‰åŒºå¯ä»¥ç”¨ [Range.deleteContent()](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FRange%2FdeleteContents) æ–¹æ³•ã€‚

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç const $text = document.createTextNode('ğŸ˜‚ğŸ˜‚ğŸ˜‚');
this.lastRange.deleteContents();
this.lastRange.insertNode($text);
```

![deleteContent.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/31dfbdfcf00f4ea792e7afca38471eaf~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) ä»ä¸Šé¢å®¢æœå‘ç°ï¼Œæ’å…¥å†…å®¹åï¼Œå†…å®¹æ˜¯è¢«é€‰åŒºé€‰ä¸­çŠ¶æ€ï¼Œå¦‚æœå¸Œæœ›å…‰æ ‡åœ¨æ’å…¥çš„å†…å®¹åé¢ï¼Œå¯ä»¥ä½¿ç”¨ [Range.setStartAfter()](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FRange%2FsetStartAfter) è®¾ç½®é€‰åŒºçš„èµ·ç‚¹ä¸ºå…ƒç´ çš„åé¢ï¼Œé»˜è®¤é€‰åŒºçš„ç»ˆç‚¹åœ¨å…ƒç´ çš„åé¢ [Range.setEndAfter()](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FRange%2FsetEndAfter)ï¼Œæ— é¡»è®¾ç½®ã€‚

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç this.lastRange.setStartAfter($text);
$input.focus();
```

![setStartAfter.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/55320e64e89e4cb4b759f3ee133681fb~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) åŒæ ·ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ [Range.setEndBefore](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FRange%2FsetEndBefore) å’Œ [setStartBefore](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FRange%2FsetStartBefore)å°†å…‰æ ‡è®¾ç½®åˆ°å†…å®¹çš„å‰é¢ã€‚

### ç»™æŒ‡å®šé€‰åŒºåŒ…è£¹æ ‡ç­¾

è¿˜æœ‰ä¸€äº›æ¯”è¾ƒé«˜çº§çš„ç”¨æ³•åº”ç”¨ï¼Œæ¯”å¦‚ç»™æŸå¥è¯åŠ èƒŒæ™¯æ ‡è®°æ•ˆæœï¼Œç±»ä¼¼ word æ–‡æ¡£æ–‡å­—é€‰ä¸­åŠ èƒŒæ™¯è‰²ã€‚å¯ä»¥é€šè¿‡ [Range.surroundContents()](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FRange%2FsurroundContents) æ–¹æ³•å®ç°ã€‚

![surroundContents.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/172cebfbc8bb44f58d91968a27f38acb~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) ä¸è¿‡ï¼Œå½“é€‰åŒºåŒ…å«å¤šä¸ªå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯æ–­å¼€äº†ä¸€ä¸ªé text èŠ‚ç‚¹ï¼ŒåªåŒ…å«äº†èŠ‚ç‚¹çš„å…¶ä¸­ä¸€ä¸ªè¾¹ç•Œï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ é‚£ä¹ˆæ€æ ·å¯ä»¥è§„é¿è¿™ä¸ªé—®é¢˜ï¼Œå®ç°è·¨å¤šä¸ªèŠ‚ç‚¹é€‰ä¸­æ ‡è®°å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ [extractContents()](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FRange%2FextractContents)ï¼Œå®ƒä¼šå°†æˆ‘ä»¬çš„é€‰åŒºå¤šèŠ‚ç‚¹ç§»åŠ¨åˆ° `DocumentFragment` å¯¹è±¡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯

> ä½¿ç”¨ DOM äº‹ä»¶æ·»åŠ çš„äº‹ä»¶ç›‘å¬å™¨åœ¨æå–æœŸé—´ä¸ä¼šä¿ç•™ã€‚HMTL å±æ€§äº‹ä»¶å°†æŒ‰ [Node.cloneNode()](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FNode%2FcloneNode) æ–¹æ³•åŸæ ·ä¿ç•™å’Œå¤åˆ¶ã€‚HTML id å±æ€§ä¹Ÿä¼šè¢«å…‹éš†ï¼Œå¦‚æœæå–äº†éƒ¨åˆ†é€‰å®šçš„èŠ‚ç‚¹å¹¶å°†å…¶é™„åŠ åˆ°æ–‡æ¡£ä¸­ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ— æ•ˆçš„æ–‡æ¡£ã€‚

ç”¨æ ‡ç­¾åŒ…è£¹è¯¥æ–‡æ¡£ç‰‡æ®µï¼Œç„¶åæ’å…¥ã€‚

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç const $mark = document.createElement('mark');
// this.lastRange.surroundContents($mark)
const fragments = this.lastRange.extractContents();
$mark.append(fragments);
this.lastRange.insertNode($mark);
```

![extractContents.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/6d750a73a7f6486e95bb8af0200319ba~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png)

### å…‰æ ‡/é€‰åŒºçš„ä½ç½®åæ ‡

æœ‰æ—¶æˆ‘ä»¬æƒ³ç¡®å®šæ–‡æœ¬åŒºåŸŸä¸­è¢«é€‰ä¸­çš„éƒ¨åˆ†æˆ–è€…å…‰æ ‡çš„è§†çª—åæ ‡ï¼Œä»¥æ­¤å¯ä»¥å°†ç±»ä¼¼å¤‡æ³¨æˆ–è€…æ‚¬æµ®æ¡†å®šä½åˆ°é™„è¿‘ã€‚è¿™é‡Œå¯ä»¥ä½¿ç”¨ [Range.getBoundingClientRect()](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FRange%2FgetBoundingClientRect) APIï¼Œå®ƒè¿”å›ä¸€ä¸ª DOMRect å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å°†èŒƒå›´ä¸­çš„å†…å®¹åŒ…å›´èµ·æ¥ï¼›å³è¯¥å¯¹è±¡æ˜¯ä¸€ä¸ªå°†èŒƒå›´å†…æ‰€æœ‰ å…ƒç´ åŒ…å›´èµ·æ¥çš„çŸ©å½¢ã€‚

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç const pos = this.lastRange.getBoundingClientRect();
const highlight = document.getElementById('highlight');
highlight.style.left = `${pos.x}px`;
highlight.style.top = `${pos.y}px`;
highlight.style.width = `${pos.width}px`;
highlight.style.height = `${pos.height}px`;
css ä»£ç è§£è¯»å¤åˆ¶ä»£ç #highlight {
  position: absolute;
  background-color: aqua;
}
```

![getBoundingClientRect.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/7588207abf194c569077abf1829c457d~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) é€‰ä¸­äº† 3 è¡Œï¼Œä½†ä¸æ˜¯å®Œæ•´çš„ 3 è¡Œï¼Œç»™å›çš„ä¿¡æ¯æ˜¯ä¸€ä¸ªæœ€å°åŒ…è£¹é€‰åŒºçš„çŸ©å½¢ä½ç½®åæ ‡ï¼Œå¦‚æœè¿˜éœ€è¦çŸ¥é“é€‰å–ä¸­æ¯ä¸ªå…ƒç´ æ›´è¯¦ç»†çš„ä½ç½®åæ ‡ï¼Œå¯ä»¥ä½¿ç”¨ [Range.getClientRects()](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FRange%2FgetClientRects)ï¼Œå®ƒè¿”å›çš„æ˜¯ä¸€ä¸ª DOMRect å¯¹è±¡åˆ—è¡¨ï¼Œè¡¨ç¤º Range åœ¨å±å¹•ä¸Šæ‰€å çš„åŒºåŸŸã€‚è¿™ä¸ªåˆ—è¡¨ç›¸å½“äºæ±‡é›†äº†èŒƒå›´ä¸­æ‰€æœ‰å…ƒç´ è°ƒç”¨ [Element.getClientRects()](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FElement%2FgetClientRects)æ–¹æ³•æ‰€å¾—åˆ°çš„ç»“æœã€‚

```javascript
javascript

 ä»£ç è§£è¯»
å¤åˆ¶ä»£ç this.lastRange.getClientRects();
```

![image.png](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/3589acd3e6e448af9d6452f01abb3a1d~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) ![image.png](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/2d14862daca64d19b7319f87031e0ee6~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) Selection&Range çš„ API å¾ˆå¤šï¼Œå¸¸ç”¨çš„å¤§è‡´ä»¥ä¸Šåˆ—ä¸¾çš„ï¼ŒåŒæ ·ç®€å•æ€»ç»“ä¸€ä¸‹ ![img](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/859d60977bd94060bc4c1e7dc8ddc80e~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png)

## @çš„åŠŸèƒ½å®ç°

å¦‚æœä½ å·²ç»ç†Ÿæ‚‰äº†ä¸Šé¢çš„ã€ŒåŸºæ“ã€ï¼Œé‚£ä¹ˆå¯¹äºå®ç°ä¸€ä¸ª@åŠŸèƒ½å·²ç»æˆåŠŸäº†ä¸€åŠï¼Œå‰©ä¸‹çš„ä¸€åŠå°±æ˜¯æ€è·¯äº†ï¼Œå¤§è‡´åˆ†ä¸ºå¦‚ä¸‹å‡ æ­¥ï¼š

1. ç›‘å¬ç”¨æˆ·è¾“å…¥äº†`@`å­—ç¬¦ï¼Œå±•ç¤ºç”¨æˆ·åˆ—è¡¨ï¼›
2. ç‚¹å‡»ç”¨æˆ·ï¼Œå¯¼è‡´è¾“å…¥æ¡†å¤±ç„¦ï¼ŒåŠæ—¶ä¿å­˜å…‰æ ‡ä¿¡æ¯ï¼›
3. ç‚¹å‡»å®Œæˆï¼Œç”¨æˆ·åˆ—è¡¨éšè—ï¼Œæ¢å¤è¾“å…¥æ¡†çš„å…‰æ ‡ï¼Œç„¶ååœ¨å…‰æ ‡åæ’å…¥ç”¨æˆ·åï¼›

é¦–å…ˆæˆ‘ä»¬å†™å¥½ `HTML`ï¼Œ`CSS` éƒ¨åˆ†åœ¨è¿™é‡Œçœç•¥

```html
html ä»£ç è§£è¯»å¤åˆ¶ä»£ç <!-- å¯Œæ–‡æœ¬èŠå¤©æ¶ˆæ¯è¾“å…¥æ¡† -->
<div
  class="chat-input"
  ref="chatInput"
  contenteditable="true"
  placeholder="è¯·è¾“å…¥å†…å®¹"
  @input="inputChatContent"
  @blur="chatContentBlur"
  @mouseup="chatContentMouseup"
></div>
<!-- ç”¨æˆ·åˆ—è¡¨æµ®çª— -->
<ul
  class="popper"
  v-show="isShowUserList"
  ref="popper"
  :style="popperStyle"
  v-click-out-hide
>
  <li v-for="(item, index) in userList" :key="index" @click="selectUser(item)">
    <el-row>{{item.name}}</el-row>
  </li>
</ul>
```

æ¥ç€æˆ‘ä»¬ç›‘å¬å¯Œæ–‡æœ¬çš„`input`äº‹ä»¶ï¼Œå½“ç›‘å¬åˆ° @ å­—ç¬¦ï¼Œå±•ç¤ºç”¨æˆ·åˆ—è¡¨ï¼Œå¦åˆ™éšè—ã€‚äºæ­¤åŒæ—¶ï¼Œä½¿ç”¨ Range.getBoundingClientRect() è·å–å…‰æ ‡çš„ä½ç½®ï¼Œè¿™æ ·æ‰èƒ½å°†ç”¨æˆ·åˆ—è¡¨æµ®æ¡†å®šä½åˆ°å…‰æ ‡é™„è¿‘ã€‚

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç /**
 * è¾“å…¥èŠå¤©å†…å®¹
 * @param {*} ev
 */
inputChatContent(ev) {
  if (ev.data === '@') {
    const pos = this.getCaretPos()
    this.showUserList()
    this.$nextTick(() => {
      this.setUserListPos(pos)
    })
  } else {
    this.hideUserList()
  }
},

/**
 * è·å–å…‰æ ‡ä½ç½®
 * @returns
 */
getCaretPos() {
  const range = this.getRange()
  const pos = range.getBoundingClientRect()

  return pos
},

/**
 * è®¾ç½®ç”¨æˆ·åˆ—è¡¨çš„ä½ç½®
 * @param {*} pos
 */
setUserListPos(pos) {
  const $popper = this.$refs.popper
  const panelWidth = $popper.offsetWidth
  const panelHeight = $popper.offsetHeight
  const { x, y } = pos

  this.popperStyle = {
    top: y - panelHeight - 20 + 'px',
    left: x - panelWidth / 2 + 'px'
  }
},

hideUserList() {
  this.isShowUserList = false
},

showUserList() {
  this.isShowUserList = true
},
```

å½“ç‚¹å‡»ç”¨æˆ·åˆ—è¡¨æ—¶ï¼Œè¾“å…¥æ¡†ä¼šå¤±ç„¦ï¼Œæ­¤æ—¶å…ˆå°†å…‰æ ‡ä¿å­˜èµ·æ¥ï¼ŒåŒæ—¶åˆ›å»ºå°†è¦æ’å…¥çš„ç”¨æˆ·åæ–‡æœ¬èŠ‚ç‚¹ï¼Œç„¶åæ¢å¤å…‰æ ‡ï¼Œå† `Range.insetNode()` å°†ç”¨æˆ·åæ–‡æœ¬èŠ‚ç‚¹ `Range.insetNode()` æ’å…¥åˆ°é€‰åŒºï¼Œæœ€å `Selection.removeAllRanges()` ç§»é™¤æ‰€æœ‰é¡µé¢é€‰åŒºï¼Œ`Selection.addRange()` æ’å…¥å½“å‰é€‰åŒºã€‚

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç  /**
 * é€‰æ‹©ç”¨æˆ·
 */
selectUser(user) {
  // è®©å¤±ç„¦äº‹ä»¶å…ˆæ‰§è¡Œ
  setTimeout(() => {
    this.hideUserList()
    this.insertContent(user)
  })
},

/**
 * æ¢å¤å…‰æ ‡
 */
restoreCaret() {
  if (this.lastRange) {
    const selection = window.getSelection()
    selection.removeAllRanges()
    selection.addRange(this.lastRange)
  }
},

/**
 * æ’å…¥å†…å®¹
 * @param {*} data
 */
insertContent(data) {
  this.restoreCaret() // è¿˜åŸå…‰æ ‡

  const selection = window.getSelection()
  const range = selection.getRangeAt(0)
  range.collapse(false) // æŠ˜å é€‰åŒºï¼Œå…‰æ ‡ç§»åˆ°æœ€å
  range.insertNode(data.content)
  range.collapse(false)

  selection.removeAllRanges()
  selection.addRange(range)
}
```

## ![at1.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/7ed07475b9e5482bb740faa773840cec~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png)

## @åŠŸèƒ½åŠ å¼ºç‰ˆ

ä»¥ä¸Šæ˜¯ç®€å•å®ç°äº†@ åŠŸèƒ½ï¼Œåœ¨å®é™…åº”ç”¨ä¸­è¿˜æœ‰æ›´å¤šæå‡ç”¨æˆ·ä½“éªŒçš„åœ°æ–¹

- å½“å‰é€šè¿‡é€€å›é”®åˆ é™¤ç”¨æˆ·å`@xxx`ï¼Œå‘ç°åˆ é™¤çš„æ˜¯é€ä¸ªå­—ç¬¦ï¼Œè€Œç”¨æˆ·æ›´å¤šæƒ³è¦çš„æ˜¯æŒ‰ä¸€ä¸‹é€€å›é”®ï¼Œåˆ é™¤æ•´ä¸ªç”¨æˆ·åï¼›
- å‘é€å‡ºå»æ€æ ·è§£ææˆåç«¯èƒ½è¯†åˆ«çš„ç‰¹å®šçš„æ•°æ®ç»“æ„ï¼Œå¹¶ä¸”ç‰¹å®šçš„æ•°æ®ç»“æ„æ€æ ·è½¬æ¢å›å¯Œæ–‡æœ¬å‘¢ï¼Ÿ

![at2.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/d956b32c036c4f9ca36e643b7e158572~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) æš‚ä¸”å¸¦è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œæ¥ç€æ€æ ·è§£å†³å‘¢ï¼Ÿ

### å®ç°æ•´ä½“åˆ é™¤ç”¨æˆ·å

é¦–å…ˆæƒ³åˆ°çš„æ˜¯ç”¨æˆ·åæ’å…¥å¯Œæ–‡æœ¬æ˜¯ä¸€ä¸ªæ ‡ç­¾ï¼ŒæŒ‰ä¸€ä¸‹é€€å›é”®ï¼Œå°±èƒ½åˆ é™¤æ•´ä¸ªæ ‡ç­¾ï¼Ÿç­”æ¡ˆæ˜¯ä¸èƒ½ï¼Œå¯Œæ–‡æœ¬æ ‡ç­¾é‡Œçš„æ–‡å­—åœ¨æ²¡æœ‰é€‰ä¸­æƒ…å†µä¸‹éƒ½æ˜¯é€ä¸ªåˆ é™¤ã€‚é™¤éè¯¥å…ƒç´ æ˜¯ä¸å¯ç¼–è¾‘å…ƒç´  `span.contentEditable = false`ã€‚ ![at3.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/6881d7d3212d41a58423259aca92b310~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) è¿™é‡Œè¦å°† `@xxx`æ”¾å…¥ä¸å¯ç¼–è¾‘æ ‡ç­¾ä¸­ï¼Œåˆ é™¤çš„æ—¶å€™æ‰èƒ½ä¸€èµ·åˆ ã€‚æ­¤æ—¶ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ¯æ¬¡æ’å…¥ç”¨æˆ·æ ‡ç­¾åï¼Œå¤šå‡ºä¸€ä¸ª@ å­—ç¬¦ï¼Œæ‰€ä»¥åœ¨ä¹‹å‰å·²ç»è¾“å…¥çš„ @ å­—ç¬¦å°±éœ€è¦åœ¨æ’å…¥æ ‡ç­¾å‰éœ€è¦åˆ é™¤æ‰ã€‚å…·ä½“å®ç°æ˜¯æ‰¾åˆ°é€‰åŒºæ‰€åœ¨çš„å¼€å§‹èŠ‚ç‚¹ `Range.startContainer`ï¼Œå†æ‰¾åˆ°é€‰åŒºç»“æŸä½ç½®çš„åç§»é‡ `Range.endOffset` ï¼Œæ­£å¸¸æƒ…å†µä¸‹é€‰åŒºç»“æŸä½ç½®çš„å‰ä¸€ä¸ªå°±æ˜¯ @å­—ç¬¦ï¼Œé€‰ä¸­åˆ é™¤å³å¯ã€‚

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç /**
 * åˆ é™¤è¾“å…¥æ¡†ä¸­å…‰æ ‡ä½ç½®ç°æœ‰çš„@å­—ç¬¦
 */
deleteCaretAtCode() {
  const range = this.getRange()
  // å…‰æ ‡å¼€å§‹èŠ‚ç‚¹å’Œå…‰æ ‡åœ¨èŠ‚ç‚¹ä¸Šçš„åç§»é‡ï¼Œæ‰¾åˆ°å…‰æ ‡å‡†ç¡®ä½ç½®ï¼Œé€‰ä¸­å…‰æ ‡ä½ç½®å‰ä¸€ä¸ªå­—ç¬¦èŒƒå›´å¹¶åˆ é™¤ï¼Œ
  const node = range.startContainer
  const end = range.endOffset

  // å¼€å§‹èŠ‚ç‚¹å†…å®¹æœ€åä¸€ä¸ªå­—ç¬¦æ˜¯@ï¼Œåˆ é™¤ï¼Œå¦åˆ™ä¸åˆ é™¤
  if (node.textContent[end - 1] === '@') {
    range.setStart(node, end ? end - 1 : 0)
    range.deleteContents()
  }
},

/**
 * è½¬æ¢è¦æ’å…¥å…‰æ ‡ä½ç½®çš„å†…å®¹
 * @param {*} data
 */
parseContent(data) {
  const { type = 'text', name } = data
  let content = null

  // type æ˜¯æ’å…¥å†…å®¹ç±»å‹ï¼Œå¯èƒ½æ˜¯æ–‡æœ¬ã€@æ ‡ç­¾ã€å›¾ç‰‡ã€è¡¨æƒ…ç­‰
  if (type === 'text') {
    content = document.createTextNode(name)
  } else if (type === 'at') {
    // åˆ é™¤è¾“å…¥æ¡†ä¸­å…‰æ ‡ä½ç½®ç°æœ‰çš„@å­—ç¬¦
    this.deleteCaretAtCode()

    const $span = document.createElement('span')
    $span.contentEditable = false
    $span.classList.add('tag')
    $span.innerHTML = `@${name}`

    // æ’å…¥ä¸€ä¸ªç©ºæ ¼å­—ç¬¦ï¼ˆ\u0010ï¼‰åˆ°@æ ‡ç­¾åé¢ï¼Œå¯ä»¥è§£å†³éƒ¨åˆ†æµè§ˆå™¨ä¸Šå…‰æ ‡åœ¨èŠå¤©è¾“å…¥æ¡†åé¢
    const $space = document.createTextNode('\u0010')
    const frag = document.createDocumentFragment()

    frag.appendChild($span)
    frag.appendChild($space)

    content = frag
  }
  return content
},

 /**
 * æ’å…¥å†…å®¹
 * @param {*} data
 */
insertContent(data) {
  this.restoreCaret() // è¿˜åŸå…‰æ ‡

  const selection = window.getSelection()
  const range = selection.getRangeAt(0)
  range.collapse(false) // æŠ˜å é€‰åŒºï¼Œå…‰æ ‡ç§»åˆ°æœ€å

  const pc = this.parseContent(data)
  range.insertNode(pc)
  range.collapse(false)

  selection.removeAllRanges()
  selection.addRange(range)
}
```

![at4.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/f882d04a1c83404a887d53bd22f044cb~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png)

### ä¸€äº›å…¼å®¹å¤„ç†

å¯èƒ½ä½ å·²ç»æ³¨æ„åˆ°äº†ï¼Œåœ¨ç”¨æˆ·æ ‡ç­¾`@xxx`åé¢è¿½åŠ äº†ä¸€ä¸ªç©ºæ ¼å­—ç¬¦ï¼Œè¿™æ ·å…‰æ ‡å¯ä»¥æ˜¾ç¤ºå‡ºæ¥ï¼Œä¸è¿‡åœ¨ç”¨é€€æ ¼é”®éœ€è¦æŒ‰ä¸¤æ¬¡åˆ é™¤æ ‡ç­¾ï¼Œè¿™é‡Œå…·ä½“çš„è¦çœ‹ä¸šåŠ¡éœ€è¦äº†ã€‚ æ³¨æ„çš„æ˜¯åœ¨ Mac Chromeï¼ˆV104ï¼‰ä¸Šï¼Œå¦‚æœåœ¨æ ‡ç­¾åé¢ä¸è¿½åŠ å­—ç¬¦ï¼Œå…‰æ ‡ä¼šåœ¨å¤–å±‚å¯Œæ–‡æœ¬æ ‡ç­¾åé¢ï¼Œåœ¨éç¼–è¾‘æ ‡ç­¾ååŠ ä»»æ„å­—ç¬¦æ˜¯æ­£å¸¸çš„ã€‚![chat-input-cursor-out.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/8607da334dec4240aa1fb13f59ce3b51~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) ç»è¿‡æµ‹è¯• Firefox æµè§ˆå™¨æœ‰è¿™æ ·çš„ bugï¼šç”¨æˆ·æ ‡ç­¾`@xxx`æ²¡æœ‰æ­£ç¡®çš„æ’å…¥åˆ°å¯Œæ–‡æœ¬è¾“å…¥æ¡†çš„ä½ç½®ï¼Œè€Œæ˜¯æ’å…¥åˆ°äº†ç”¨æˆ·åˆ—è¡¨ç‚¹å‡»çš„é‚£ä¸€é¡¹ä¸Šäº†ã€‚![firefox.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/2cda7d54d0a843e48522488cf3871fad~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) å¤§èƒ†æ¨æµ‹ Firefox å°†æ™®é€šå…ƒç´ ä¹Ÿå¯ä»¥è®¾ç½®å…‰æ ‡ï¼Œè¿™æ ·ç‚¹å‡»ç”¨æˆ·åˆ—è¡¨æŸä¸€é¡¹å…ƒç´ æ—¶ï¼Œè¯¥å…ƒç´ è·å¾—å…‰æ ‡ï¼Œå†è·å–æ–°é€‰åŒº `selection.getRangeAt(0)`å…¶å®æ˜¯åœ¨ç‚¹å‡»çš„è¿™ä¸ªå…ƒç´ ä¸Šï¼Œéæ¢å¤çš„å¯Œæ–‡æœ¬è¾“å…¥æ¡†ä¸Šï¼Œç„¶åæ’å…¥ç”¨æˆ·æ ‡ç­¾ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„æƒ…æ™¯ã€‚ è¿™é‡Œæˆ‘çš„è§£å†³æ–¹æ³•æ˜¯å°†ç”¨æˆ·åˆ—è¡¨é¡¹è®¾ç½®ä¸ºä¸å¯é€‰ä¸­çš„ï¼Œè‡ªç„¶å°±æ— æ³•è·å–å…‰æ ‡ã€‚

```css
css ä»£ç è§£è¯»å¤åˆ¶ä»£ç .popper li {
  /* ç”¨æˆ·ä¸èƒ½é€‰ä¸­æ–‡æœ¬ firfox éç¼–è¾‘ç¼–è¾‘å…ƒç´ ä¹Ÿå¯é€‰ä¸­ */
  user-select: none;
  -webkit-user-select: none;
  list-style: none;
  padding: 10px;
}
```

![Firefox1.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/978675ce377a41659e8d5e80ad3948d3~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) æˆ‘ä»¬å†çœ‹çœ‹å† Safari ä¸Šçš„è¡¨ç° ![Safari1.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/dcccfa36e8774e868a1cbb282610d054~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) å‘ç°æ˜¯æ²¡æœ‰æŒ‰ç…§é¢„æƒ³çš„åˆ é™¤æ‰å‰ç½®çš„`@`å­—ç¬¦çš„ï¼ŒæŸ¥çœ‹æ§åˆ¶å°æœ‰æŠ¥é”™ ![image.png](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/7e2b653f93bc4a919fbfcdaf85f07f48~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) å¤§è‡´æ„æ€æ˜¯ `selection.getRangeAt(0)`ä¸­ç¬¬ 0 ä½æ˜¯è¶…å‡ºå…è®¸çš„èŒƒå›´çš„ï¼Œéš¾é“åœ¨è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹çš„æƒ…æ™¯ä¸‹ï¼ŒSafari é»˜è®¤å°†é€‰åŒºç»™æ¸…ç©ºäº†ï¼Ÿé€šè¿‡å®éªŒå‘ç°ç¡®å®å¦‚æ­¤

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç // è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹å’Œè·å–ç„¦ç‚¹æ—¶æ‰“å°é€‰åŒºä¸ªæ•°
const selection = window.getSelection();
console.log('selection.rangeCount: ', selection.rangeCount);
```

![Safari2.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/b18bb2f954314aa5a98f820d0ee64cad~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) è€Œæ­£å¸¸å…¶ä»–æµè§ˆå™¨é€‰åŒºä¸ªæ•°ä¿æŒä¸å˜ ![Safari3.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/f05c45338f6340458fce64197d490f65~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png) é‚£æ€æ ·è§£å†³è¿™ç§æƒ…æ™¯å‘¢ï¼Ÿæˆ‘ä»¬æ˜¯åœ¨è¾“å…¥æ¡†å¤±ç„¦çš„æ—¶å€™ä¿å­˜é€‰åŒºçš„ï¼Œæ­¤æ—¶ Safari å·²ç»æ¸…ç©ºäº†é€‰åŒºï¼Œå¯¼è‡´è¿™ä¸ªæ—¶å€™ä¿å­˜çš„é€‰åŒºæ˜¯ç©ºçš„ï¼Œå› æ­¤æˆ‘ä»¬è¦å°†é€‰åŒºä¿å­˜å‰ç½®ä¸€ä¸‹ï¼Œåœ¨è¾“å…¥`@`å­—ç¬¦æ—¶å€™å°±ä¿å­˜ä¸€ä¸‹é€‰åŒºï¼ˆå…‰æ ‡ï¼‰ï¼Œå¯ä»¥è¿™æ ·åš

```javascript
javascript ä»£ç è§£è¯»å¤åˆ¶ä»£ç /**
 * è¾“å…¥èŠå¤©å†…å®¹
 * @param {*} ev
 */
inputChatContent(ev) {
  if (ev.data === '@') {
    // åœ¨è¾“å…¥@å­—ç¬¦æ—¶å€™å°±ä¿å­˜ä¸€ä¸‹å…‰æ ‡
    this.saveCaret()
    const pos = this.getCaretPos()
    this.showUserList()
    this.$nextTick(() => {
      this.setUserListPos(pos)
    })
  } else {
    this.hideUserList()
  }
},
```

![Safari.gif](./20240710-å®Œç¾å®ç°ä¸€ä¸ª@åŠŸèƒ½.assets/afc053312b9c4c75bca95ab76050d452~tplv-k3u1fbpfcp-zoom-in-crop-mark_1512_0_0_0.png)



